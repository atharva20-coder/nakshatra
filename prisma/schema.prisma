// Complete Prisma Schema for Bank Portal
generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Post {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  title     String
  content   String
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("posts")
}

model User {
  id                          String                              @id @default(uuid())
  createdAt                   DateTime                            @default(now())
  updatedAt                   DateTime                            @updatedAt
  name                        String
  email                       String                              @unique
  emailVerified               Boolean                             @default(false)
  image                       String?
  role                        UserRole                            @default(USER)
  banned                      Boolean?                            @default(false)
  banReason                   String?
  banExpires                  DateTime?

  accounts                    Account[]

  // Form Relations
  codeOfConduct               CodeOfConduct[]
  declarationCumUndertaking   DeclarationCumUndertaking[]
  agencyVisits                AgencyVisit[]
  complianceForms             MonthlyCompliance[] @relation("AgencyComplianceForms")
  assetManagement             AssetManagement[]
  telephoneDeclaration        TelephoneDeclaration[]
  agencyManpowerRegister      AgencyManpowerRegister[]
  productDeclaration          ProductDeclaration[]
  agencyPenaltyMatrix         AgencyPenaltyMatrix[] // Note: This model is now legacy
  agencyTrainingTracker       AgencyTrainingTracker[]
  proactiveEscalationTracker  ProactiveEscalationTracker[]
  escalationDetails           EscalationDetails[]
  paymentRegister             PaymentRegister[]
  repoKitTracker              RepoKitTracker[]
  noDuesDeclarations          NoDuesDeclaration[]

  posts                       Post[]
  sessions                    Session[]
  approvalRequests            ApprovalRequest[]
  monthlySubmissions          MonthlySubmission[]

  // Notifications and Activity Logs
  notifications               Notification[]
  activityLogs                ActivityLog[]

  // Auditor relations
  auditor                     Auditor?
  agencyAssignments           AgencyAssignment[]
  auditsReceived              Audit[]                             @relation("AuditAgency")
  penalties                   Penalty[]
  // Note: The relation for AuditScorecard is on the Auditor model, not User

  // CM relations
  cmProfile                   CollectionManagerProfile?
  cmAssignedAgencies          CMAgencyAssignment[] @relation("CMAssignedAgencies")
  cmApprovalsReceived         CMApproval[] @relation("CMApprovals")

  // --- NEW SCN & ANNOUNCEMENT RELATIONS ---
  issuedShowCauseNotices      ShowCauseNotice[]   @relation("IssuedByAdmin")
  receivedShowCauseNotices    ShowCauseNotice[]   @relation("ReceivedByAgency")
  showCauseResponses          ShowCauseResponse[]
  createdAnnouncements        Announcement[]
  readAnnouncements           AnnouncementRead[]
  // --- END NEW RELATIONS ---

  @@map("users")
}


// Monthly Submissions Tracking
model MonthlySubmission {
  id            String           @id @default(uuid())
  userId        String
  user          User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  submittedAt   DateTime?
  autoSubmitted Boolean          @default(false)
  status        SubmissionStatus @default(DRAFT)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  @@unique([userId, createdAt])
  @@map("monthly_submissions")
}

// 1. Code of Conduct
model CodeOfConduct {
  id                String                @id @default(uuid())
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
  userId            String
  user              User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  status            SubmissionStatus      @default(DRAFT)
  details           CodeOfConductDetail[]

  @@map("code_of_conduct")
}

model CodeOfConductDetail {
  id                String           @id @default(uuid())
  name              String
  signature         String
  date              DateTime
  conductId         String
  conduct           CodeOfConduct    @relation(fields: [conductId], references: [id], onDelete: Cascade)

  @@map("code_of_conduct_details")
}

// 2. Declaration Cum Undertaking
model DeclarationCumUndertaking {
  id                          String                             @id @default(uuid())
  createdAt                   DateTime                           @default(now())
  updatedAt                   DateTime                           @updatedAt
  userId                      String
  user                        User                               @relation(fields: [userId], references: [id], onDelete: Cascade)
  status                      SubmissionStatus                   @default(DRAFT)
  collectionManagers          DeclarationCollectionManager[]

  @@map("declaration_cum_undertaking")
}

model DeclarationCollectionManager {
  id                    String                    @id @default(uuid())
  name                  String
  employeeId            String
  signature             String
  declarationId         String
  declaration           DeclarationCumUndertaking @relation(fields: [declarationId], references: [id], onDelete: Cascade)

  @@map("declaration_collection_managers")
}

// 3. Agency Visit Details
model AgencyVisit {
  id        String           @id @default(uuid())
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  status    SubmissionStatus @default(DRAFT)
  agencyId  String
  agency    User             @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  details   VisitDetail[]

  @@map("agency_visits")
}

model VisitDetail {
  id             String      @id @default(uuid())
  srNo           String
  dateOfVisit    String
  employeeId     String
  employeeName   String
  mobileNo       String
  branchLocation String
  product        String
  bucketDpd      String
  timeIn         String
  timeOut        String
  signature      String
  purposeOfVisit String
  visitId        String
  visit          AgencyVisit @relation(fields: [visitId], references: [id], onDelete: Cascade)

  @@map("visit_details")
}

// 4. Monthly Compliance
model ComplianceParameter {
  id          String   @id @default(uuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  srNo        Int      @unique
  parameter   String   @db.Text
  category    String?
  isActive    Boolean  @default(true)
  responses   ComplianceResponse[]

  @@map("compliance_parameters")
  @@index([isActive, srNo])
}

model MonthlyCompliance {
  id          String   @id @default(uuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  agencyId    String
  agency      User     @relation("AgencyComplianceForms", fields: [agencyId], references: [id], onDelete: Cascade)
  month       Int
  year        Int
  status      SubmissionStatus @default(DRAFT)
  submittedAt DateTime?
  responses   ComplianceResponse[]
  cmSignatures CMComplianceSignature[]

  @@unique([agencyId, month, year])
  @@map("monthly_compliance_forms")
  @@index([agencyId, status])
  @@index([month, year])
}

model ComplianceResponse {
  id            String   @id @default(uuid())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  formId        String
  form          MonthlyCompliance @relation(fields: [formId], references: [id], onDelete: Cascade)
  parameterId   String
  parameter     ComplianceParameter @relation(fields: [parameterId], references: [id], onDelete: Cascade)
  complied      ComplianceStatus @default(PENDING)
  agencyRemarks String?  @db.Text
  approvals     Json?
  lastUpdatedBy String?

  @@unique([formId, parameterId])
  @@map("compliance_responses")
  @@index([formId])
  @@index([parameterId])
  @@index([complied])
}

// 5. Asset Management Declaration
model AssetManagement {
  id        String           @id @default(uuid())
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  status    SubmissionStatus @default(DRAFT)
  details   AssetManagementDetail[]

  @@map("asset_management")
}

model AssetManagementDetail {
  id                    String          @id @default(uuid())
  srNo                  String
  systemCpuSerialNo     String
  ipAddress             String
  executiveName         String
  idCardNumber          String
  printerAccess         String
  assetDisposed         String
  assetManagementId     String
  assetManagement       AssetManagement @relation(fields: [assetManagementId], references: [id], onDelete: Cascade)

  @@map("asset_management_details")
}

// 6. Telephone Lines Declaration
model TelephoneDeclaration {
  id        String           @id @default(uuid())
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  status    SubmissionStatus @default(DRAFT)
  details   TelephoneDetail[]

  @@map("telephone_declaration")
}

model TelephoneDetail {
  id                    String               @id @default(uuid())
  srNo                  String
  telephoneNo           String
  username              String
  executiveCategory     String
  recordingLine         String
  remarks               String?
  telephoneDeclarationId String
  telephoneDeclaration  TelephoneDeclaration @relation(fields: [telephoneDeclarationId], references: [id], onDelete: Cascade)

  @@map("telephone_details")
}

// 7. Agency Manpower Register
model AgencyManpowerRegister {
  id        String           @id @default(uuid())
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  status    SubmissionStatus @default(DRAFT)
  details   ManpowerDetail[]

  @@map("agency_manpower_register")
}

model ManpowerDetail {
  id                      String                  @id @default(uuid())
  srNo                    String
  executiveCategory       String
  hhdIdOfFos              String?
  axisIdOfFos             String?
  fosFullName             String
  dateOfJoining           DateTime
  product                 String
  cocSigned               String
  collectionManagerName   String
  collectionManagerId     String
  collectionManagerSign   String
  dateOfResignation       DateTime?
  idCardsIssuanceDate     DateTime?
  idCardReturnDate        DateTime?
  executiveSignature      String
  remarks                 String?
  manpowerRegisterId      String
  manpowerRegister        AgencyManpowerRegister @relation(fields: [manpowerRegisterId], references: [id], onDelete: Cascade)

  @@map("manpower_details")
}

// 8. Declaration of Product
model ProductDeclaration {
  id        String           @id @default(uuid())
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  status    SubmissionStatus @default(DRAFT)
  details   ProductDetail[]

  @@map("product_declaration")
}

model ProductDetail {
  id                        String              @id @default(uuid())
  product                   String
  bucket                    String
  countOfCaseAllocated      Int
  collectionManagerName     String
  collectionManagerLocation String
  cmSign                    String
  productDeclarationId      String
  productDeclaration        ProductDeclaration @relation(fields: [productDeclarationId], references: [id], onDelete: Cascade)

  @@map("product_details")
}

// 9. Agency Penalty Matrix (Legacy Model)
// This model is no longer used for new penalties. It is kept for historical data.
// The new "Penalty Matrix" is a read-only view of the `Penalty` model.
model AgencyPenaltyMatrix {
  id        String           @id @default(uuid())
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  status    SubmissionStatus @default(DRAFT)
  details   PenaltyDetail[]

  @@map("agency_penalty_matrix")
}

model PenaltyDetail {
  id                           String                @id @default(uuid())
  noticeRefNo                  String
  nonComplianceMonth           String
  parameter                    String
  product                      String
  penaltyAmount                Decimal               @db.Decimal(10, 2)
  penaltyDeductedMonth         String
  correctiveActionTaken        String
  agency                       String
  agencyAuthorisedPersonSign   String
  signOfFpr                    String
  penaltyMatrixId              String
  penaltyMatrix                AgencyPenaltyMatrix @relation(fields: [penaltyMatrixId], references: [id], onDelete: Cascade)

  @@map("penalty_details")
}

// 10. Agency Training Tracker
model AgencyTrainingTracker {
  id        String           @id @default(uuid())
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  status    SubmissionStatus @default(DRAFT)
  details   TrainingDetail[]

  @@map("agency_training_tracker")
}

model TrainingDetail {
  id                  String                 @id @default(uuid())
  dateOfTraining      DateTime
  trainingAgenda      String
  trainingName        String
  trainerName         String
  trainerEmpId        String
  noOfAttendees       Int
  trainerRemarks      String?
  trainingTrackerId   String
  trainingTracker     AgencyTrainingTracker @relation(fields: [trainingTrackerId], references: [id], onDelete: Cascade)

  @@map("training_details")
}

// 11. Proactive Escalation Management Tracker
model ProactiveEscalationTracker {
  id        String           @id @default(uuid())
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  status    SubmissionStatus @default(DRAFT)
  details   ProactiveEscalationDetail[]

  @@map("proactive_escalation_tracker")
}

model ProactiveEscalationDetail {
  id                        String                      @id @default(uuid())
  lanCardNo                 String
  customerName              String
  product                   String
  currentBucket             String
  dateOfContact             DateTime
  modeOfContact             String
  dateOfTrailUploaded       DateTime?
  listOfCaseWithReasons     String
  collectionManagerNameId   String
  escalationTrackerId       String
  escalationTracker         ProactiveEscalationTracker @relation(fields: [escalationTrackerId], references: [id], onDelete: Cascade)

  @@map("proactive_escalation_details")
}

// 12. Escalation Details
model EscalationDetails {
  id        String           @id @default(uuid())
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  status    SubmissionStatus @default(DRAFT)
  details   EscalationDetail[]

  @@map("escalation_details_form")
}

model EscalationDetail {
  id                        String             @id @default(uuid())
  customerName              String
  loanCardNo                String
  productBucketDpd          String
  dateEscalation            DateTime
  escalationDetail          String
  collectionManagerRemark   String?
  collectionManagerSign     String
  escalationDetailsId       String
  escalationDetails         EscalationDetails @relation(fields: [escalationDetailsId], references: [id], onDelete: Cascade)

  @@map("escalation_detail_entries")
}

// 13. Payment Register
model PaymentRegister {
  id        String           @id @default(uuid())
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  status    SubmissionStatus @default(DRAFT)
  details   PaymentDetail[]

  @@map("payment_register")
}

model PaymentDetail {
  id                    String          @id @default(uuid())
  srNo                  String
  month                 String
  eReceiptNo            String
  accountNo             String
  customerName          String
  receiptAmount         Decimal         @db.Decimal(10, 2)
  modeOfPayment         String
  depositionDate        DateTime
  fosHhdId              String
  fosName               String
  fosSign               String
  cmName                String
  cmVerificationStatus  String
  remarks               String?
  paymentRegisterId     String
  paymentRegister       PaymentRegister @relation(fields: [paymentRegisterId], references: [id], onDelete: Cascade)

  @@map("payment_details")
}

// 14. Repo Kit Tracker
model RepoKitTracker {
  id        String           @id @default(uuid())
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  status    SubmissionStatus @default(DRAFT)
  details   RepoKitDetail[]

  @@map("repo_kit_tracker")
}

model RepoKitDetail {
  id                      String         @id @default(uuid())
  srNo                    String
  repoKitNo               String
  issueDateFromBank       DateTime
  lanNo                   String
  product                 String
  bucketDpd               String
  usedUnused              String
  executiveSign           String
  dateOfReturnToCo        DateTime?
  collectionManagerEmpId  String
  collectionManagerSign   String
  repoKitTrackerId        String
  repoKitTracker          RepoKitTracker @relation(fields: [repoKitTrackerId], references: [id], onDelete: Cascade)

  @@map("repo_kit_details")
}

// 15. No Dues Declaration
model NoDuesDeclaration {
  id        String           @id @default(uuid())
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  
  agencyId  String
  agency    User             @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  
  month     Int              // 1-12
  year      Int              // 2025
  
  status    SubmissionStatus @default(DRAFT)
  details   NoDuesDetail[]

  @@unique([agencyId, month, year])
  @@map("no_dues_declarations")
}

model NoDuesDetail {
  id                String            @id @default(uuid())
  formId            String
  form              NoDuesDeclaration @relation(fields: [formId], references: [id], onDelete: Cascade)
  
  productBucket     String            // "Credit Card / X-Bucket"
  month             String            // Month of declaration (e.g., "Nov-2025")
  remarksBillAmount String?           // "No Dues" or "Bill Amount: 5000"
  
  @@map("no_dues_details")
  @@index([formId])
}


// 16. Audit Scorecard
model AuditScorecard {
  id            String   @id @default(uuid())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  auditId       String   @unique // One scorecard per audit
  audit         Audit    @relation(fields: [auditId], references: [id], onDelete: Cascade)

  auditorProfileId String   
  auditor          Auditor  @relation("AuditorScorecards", fields: [auditorProfileId], references: [id], onDelete: Restrict)
  
  // Scorecard fields
  auditPeriod   String   // "Jan-2025 to Mar-2025"
  auditScore    Float    // e.g., 85.5
  auditGrade    String   // "A", "B+", "C"
  auditCategory String   // "High Risk", "Medium Risk"

  finalObservation String @db.Text
  justification    String @db.Text
  signedAt         DateTime @default(now())
  
  @@map("audit_scorecards")
  @@index([auditorProfileId])
}


// ============================================
// --- APPROVAL & AUTH MODELS ---
// ============================================

model ApprovalRequest {
  id            String            @id @default(uuid())
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  userId        String
  user          User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  formType      String
  formId        String
  requestType   ApprovalType
  reason        String
  documentPath  String?
  status        ApprovalStatus    @default(PENDING)
  adminResponse String?
  reviewedAt    DateTime?
  reviewedBy    String?

  @@map("approval_requests")
}

model UploadedFile {
  id            String   @id @default(uuid())
  createdAt     DateTime @default(now())
  fileName      String
  originalName  String
  filePath      String
  fileSize      Int
  mimeType      String
  uploadedBy    String

  @@map("uploaded_files")
}

model Session {
  id             String   @id @default(uuid())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  expiresAt      DateTime
  token          String   @unique
  ipAddress      String?
  userAgent      String?
  impersonatedBy String?
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model Account {
  id                    String    @id @default(uuid())
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  accountId             String
  providerId            String
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId, accountId])
  @@map("accounts")
}

model Verification {
  id         String    @id @default(uuid())
  createdAt  DateTime? @default(now())
  updatedAt  DateTime? @updatedAt
  identifier String
  value      String
  expiresAt  DateTime

  @@unique([identifier, value])
  @@map("verifications")
}

// ============================================
// --- NOTIFICATION & LOGGING MODELS ---
// ============================================

model Notification {
  id            String              @id @default(uuid())
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  userId        String
  user          User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  type          NotificationType
  title         String
  message       String
  link          String?
  read          Boolean             @default(false)
  readAt        DateTime?
  relatedId     String?
  relatedType   String?

  @@map("notifications")
  @@index([userId, read])
  @@index([createdAt])
}

model ActivityLog {
  id            String        @id @default(uuid())
  createdAt     DateTime      @default(now())
  userId        String
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  action        ActivityAction
  entityType    String
  entityId      String?
  description   String
  metadata      Json?
  ipAddress     String?
  userAgent     String?

  @@map("activity_logs")
  @@index([userId, createdAt])
  @@index([entityType, entityId])
}

// ============================================
// --- CM & AUDITOR MODELS ---
// ============================================

model CollectionManagerProfile {
  id                    String   @id @default(uuid())
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  userId                String   @unique
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  employeeId            String   @unique
  designation           String
  department            String?
  productsAssigned      String[]
  
  supervisorId          String?
  supervisor            CollectionManagerProfile?  @relation("CMSupervisor", fields: [supervisorId], references: [id], onDelete: SetNull)
  subordinates          CollectionManagerProfile[] @relation("CMSupervisor")
  supervisorDesignation String?
  
  agencyAssignments     CMAgencyAssignment[]
  approvalsGiven        CMApproval[]
  cmComplianceSignatures CMComplianceSignature[]
  
  notificationsEnabled  Boolean  @default(true)
  emailNotifications    Boolean  @default(true)
  
  @@map("collection_manager_profiles")
  @@index([employeeId])
  @@index([supervisorId])
}

model CMAgencyAssignment {
  id              String   @id @default(uuid())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  cmProfileId     String
  cmProfile       CollectionManagerProfile @relation(fields: [cmProfileId], references: [id], onDelete: Cascade)
  
  agencyId        String
  agency          User     @relation("CMAssignedAgencies", fields: [agencyId], references: [id], onDelete: Cascade)
  
  assignedBy      String
  assignedAt      DateTime @default(now())
  isActive        Boolean  @default(true)
  
  viewedByAt      DateTime?

  @@unique([cmProfileId, agencyId])
  @@map("cm_agency_assignments")
  @@index([cmProfileId])
  @@index([agencyId])
  @@index([isActive])
}

model CMApproval {
  id                    String   @id @default(uuid())
  createdAt             DateTime @default(now())
  
  cmProfileId           String
  cmProfile             CollectionManagerProfile @relation(fields: [cmProfileId], references: [id], onDelete: Cascade)
  
  agencyId              String
  agency                User     @relation("CMApprovals", fields: [agencyId], references: [id], onDelete: Cascade)
  
  formType              String   // e.g., "agencyVisits", "noDuesDeclaration"
  formId                String   // ID of the parent form
  rowId                 String?  // ID of the specific detail row (e.g., NoDuesDetail.id)
  
  approvalSignature     String
  productTag            String
  remarks               String?
  
  ipAddress             String?
  userAgent             String?
  reportedToSupervisor  Boolean  @default(false)
  
  @@map("cm_approvals")
  @@index([cmProfileId])
  @@index([agencyId])
  @@index([formType, formId])
  @@index([createdAt])
}

model CMComplianceSignature {
  id          String   @id @default(uuid())
  
  cmProfileId String
  cmProfile   CollectionManagerProfile @relation(fields: [cmProfileId], references: [id], onDelete: Cascade)
  
  formId      String
  form        MonthlyCompliance @relation(fields: [formId], references: [id], onDelete: Cascade)
  
  product     String
  signedAt    DateTime @default(now())
  remarks     String?
  ipAddress   String?

  @@unique([cmProfileId, formId, product])
  @@map("cm_compliance_signatures")
}


// Auditing Firm model
model AuditingFirm {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  name      String   @unique

  address       String?  @db.Text
  contactPerson String?
  contactEmail  String?
  contactPhone  String?

  auditors          Auditor[]
  audits            Audit[]
  agencyAssignments AgencyAssignment[]

  @@map("auditing_firms")
}

// Auditor model (links users to firms)
model Auditor {
  id          String       @id @default(uuid())
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  userId      String       @unique
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  firmId      String
  firm        AuditingFirm @relation(fields: [firmId], references: [id], onDelete: Cascade)

  audits          Audit[]
  auditScorecards AuditScorecard[] @relation("AuditorScorecards")

  @@map("auditors")
}

// Agency Assignment to Auditing Firm
model AgencyAssignment {
  id          String       @id @default(uuid())
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  agencyId    String
  agency      User         @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  firmId      String
  firm        AuditingFirm @relation(fields: [firmId], references: [id], onDelete: Cascade)
  assignedBy  String
  assignedAt  DateTime     @default(now())
  isActive    Boolean      @default(true)
  viewedByAt  DateTime?

  @@unique([agencyId, firmId])
  @@map("agency_assignments")
}

// Audit model
model Audit {
  id                String       @id @default(uuid())
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  agencyId          String
  agency            User         @relation("AuditAgency", fields: [agencyId], references: [id], onDelete: Cascade)
  firmId            String
  firm              AuditingFirm @relation(fields: [firmId], references: [id], onDelete: Cascade)
  auditorId         String
  auditor           Auditor      @relation(fields: [auditorId], references: [id])
  auditDate         DateTime
  auditorName       String
  auditorEmployeeId String?
  location          String?
  remarks           String?
  status            AuditStatus  @default(IN_PROGRESS)
  observations      Observation[]
  scorecard         AuditScorecard?

  @@map("audits")
}

// Observation model
model Observation {
  id                 String              @id @default(uuid())
  createdAt          DateTime            @default(now()) // <-- This is WHEN the observation was created
  updatedAt          DateTime            @updatedAt
  auditId            String
  audit              Audit               @relation(fields: [auditId], references: [id], onDelete: Cascade)
  observationNumber  String
  category           String
  severity           ObservationSeverity @default(MEDIUM)
  description        String              @db.Text
  evidenceRequired   Boolean             @default(false)
  visibleToAgency    Boolean             @default(false)
  sentToAgencyAt     DateTime?
  sentBy             String?
  status             ObservationStatus   @default(PENDING_ADMIN_REVIEW)
  agencyResponse     String?             @db.Text
  agencyAccepted     Boolean?
  agencyResponseDate DateTime?
  evidenceSubmitted  Boolean             @default(false)
  evidencePath       String?
  responseDeadline   DateTime?
  autoAcceptedAt     DateTime?
  penaltyAssigned    Boolean             @default(false)
  penaltyId          String?             @unique
  penalty            Penalty?            @relation(fields: [penaltyId], references: [id], onDelete: SetNull)

  // --- SCN RELATION ---
  showCauseNoticeId  String?
  showCauseNotice    ShowCauseNotice?    @relation(fields: [showCauseNoticeId], references: [id], onDelete: SetNull)
  // --- END SCN RELATION ---

  @@map("observations")
  @@index([auditId])
  @@index([status])
  @@index([showCauseNoticeId])
}

// Penalty model
model Penalty {
  id                   String        @id @default(uuid())
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt
  observationId        String        @unique
  observation          Observation?
  agencyId             String
  agency               User          @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  penaltyAmount        Decimal       @db.Decimal(10, 2)
  penaltyReason        String        @db.Text
  deductionMonth       String
  status               PenaltyStatus @default(DRAFT)
  
  // --- NEW FIELD ---
  noticeRefNo          String?       // Stores the SCN ID or a reference

  assignedBy           String
  assignedAt           DateTime      @default(now())
  submittedAt          DateTime?
  acknowledgedByAgency Boolean       @default(false)
  acknowledgedAt       DateTime?
  correctiveAction     String?       @db.Text

  @@map("penalties")
  @@index([agencyId])
  @@index([status])
}


// ============================================
// --- NEW SCN MODELS ---
// ============================================

model ShowCauseNotice {
  id              String   @id @default(uuid())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  issuedByAdminId String
  issuedByAdmin   User     @relation("IssuedByAdmin", fields: [issuedByAdminId], references: [id], onDelete: Restrict) // Admin who issued it

  receivedByAgencyId String
  receivedByAgency   User     @relation("ReceivedByAgency", fields: [receivedByAgencyId], references: [id], onDelete: Cascade) // Agency who received it

  subject         String   @db.Text
  details         String   @db.Text
  responseDueDate DateTime
  
  status          ShowCauseStatus @default(ISSUED)
  adminRemarks    String?         @db.Text // Final closing remarks from admin

  observations    Observation[]
  responses       ShowCauseResponse[]
  
  @@map("show_cause_notices")
  @@index([issuedByAdminId])
  @@index([receivedByAgencyId])
  @@index([status])
}

model ShowCauseResponse {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  
  noticeId  String
  notice    ShowCauseNotice @relation(fields: [noticeId], references: [id], onDelete: Cascade)
  
  authorId  String
  author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade) // Agency user who responded
  
  response  String   @db.Text // This is a general response to the SCN, not the observation
  
  @@map("show_cause_responses")
  @@index([noticeId])
  @@index([authorId])
}

// ============================================
// --- NEW ANNOUNCEMENT MODELS ---
// ============================================

model Announcement {
  id          String     @id @default(uuid())
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  authorId    String
  author      User       @relation(fields: [authorId], references: [id], onDelete: Restrict) // Super Admin

  title       String     @db.Text
  content     String     @db.Text
  
  audience    UserRole[] // Array of roles to target (e.g., [ADMIN, USER, AUDITOR])
  
  readBy      AnnouncementRead[]

  @@map("announcements")
  @@index([authorId])
}

model AnnouncementRead {
  id             String       @id @default(uuid())
  readAt         DateTime     @default(now())
  
  announcementId String
  announcement   Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)
  
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([announcementId, userId]) // User can only read an announcement once
  @@map("announcement_reads")
  @@index([userId])
}


// ============================================
// --- ENUMS ---
// ============================================

enum UserRole {
  SUPER_ADMIN
  USER
  ADMIN
  AUDITOR
  COLLECTION_MANAGER
}

enum SubmissionStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
}

enum ApprovalType {
  UPDATE_SUBMITTED_FORM
  UPDATE_PREVIOUS_MONTH
  DELETE_RECORD
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  REVISED
}

enum NotificationType {
  APPROVAL_REQUESTED
  APPROVAL_APPROVED
  APPROVAL_REJECTED
  DOCUMENT_REQUESTED
  FORM_SUBMITTED
  FORM_LOCKED
  SYSTEM_ALERT
  // --- NEW ---
  SHOW_CAUSE_ISSUED
  SHOW_CAUSE_RESPONSE_RECEIVED
  SHOW_CAUSE_CLOSED
}

enum ActivityAction {
  FORM_CREATED
  FORM_UPDATED
  FORM_SUBMITTED
  FORM_RESUBMITTED
  FORM_DELETED
  APPROVAL_REQUESTED
  APPROVAL_GRANTED
  APPROVAL_REJECTED
  DOCUMENT_UPLOADED
  USER_LOGIN
  USER_LOGOUT
  SETTINGS_CHANGED
  AUDIT_CREATED
  OBSERVATION_ADDED
  OBSERVATION_SENT_TO_AGENCY
  OBSERVATION_RESPONDED
  PENALTY_ASSIGNED
  PENALTY_SUBMITTED
  AGENCY_ASSIGNED_TO_FIRM
  // --- NEW ---
  SHOW_CAUSE_ISSUED
  SHOW_CAUSE_RESPONDED
  SHOW_CAUSE_CLOSED
}

enum AuditStatus {
  IN_PROGRESS
  COMPLETED
  UNDER_REVIEW
  CLOSED
}

enum ObservationSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ObservationStatus {
  PENDING_ADMIN_REVIEW
  SENT_TO_AGENCY
  AWAITING_AGENCY_RESPONSE
  AGENCY_ACCEPTED
  AGENCY_DISPUTED
  AUTO_ACCEPTED
  RESOLVED
  CLOSED
}

enum PenaltyStatus {
  DRAFT
  SUBMITTED
  ACKNOWLEDGED
  PAID
}

enum ComplianceStatus {
  PENDING
  YES
  NO
  NA
}

// --- NEW ---
enum ShowCauseStatus {
  ISSUED
  RESPONDED
  CLOSED
}