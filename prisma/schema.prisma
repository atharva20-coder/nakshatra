// Complete Prisma Schema for Bank Portal
generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Post {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  title     String
  content   String
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("posts")
}

model User {
  id                          String                              @id @default(uuid())
  createdAt                   DateTime                            @default(now()) // Added default
  updatedAt                   DateTime                            @updatedAt
  name                        String
  email                       String                              @unique
  emailVerified               Boolean                             @default(false) // Added default
  image                       String?
  role                        UserRole                            @default(USER)
  banned                      Boolean?                            @default(false) // Added default
  banReason                   String?
  banExpires                  DateTime?
  accounts                    Account[]

  // Form Relations
  codeOfConduct               CodeOfConduct[]
  declarationCumUndertaking   DeclarationCumUndertaking[]
  agencyVisits                AgencyVisit[]
  monthlyCompliance           MonthlyCompliance[]
  assetManagement             AssetManagement[]
  telephoneDeclaration        TelephoneDeclaration[]
  agencyManpowerRegister      AgencyManpowerRegister[]
  productDeclaration          ProductDeclaration[]
  agencyPenaltyMatrix         AgencyPenaltyMatrix[]
  agencyTrainingTracker       AgencyTrainingTracker[]
  proactiveEscalationTracker  ProactiveEscalationTracker[]
  escalationDetails           EscalationDetails[]
  paymentRegister             PaymentRegister[]
  repoKitTracker              RepoKitTracker[]

  posts                       Post[]
  sessions                    Session[]
  approvalRequests            ApprovalRequest[]
  monthlySubmissions          MonthlySubmission[]

  // Notifications and Activity Logs
  notifications               Notification[]
  activityLogs                ActivityLog[]

  // NEW Auditor relations
  auditor                     Auditor?
  agencyAssignments           AgencyAssignment[]
  auditsReceived              Audit[]                             @relation("AuditAgency") // Clarified relation name
  penalties                   Penalty[]

  cmProfile                   CollectionManagerProfile?
  cmAssignedAgencies          CMAgencyAssignment[] @relation("CMAssignedAgencies")
  cmApprovalsReceived         CMApproval[] @relation("CMApprovals")

  @@map("users")
}


// Monthly Submissions Tracking
model MonthlySubmission {
  id            String           @id @default(uuid())
  userId        String
  user          User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  submittedAt   DateTime?
  autoSubmitted Boolean          @default(false)
  status        SubmissionStatus @default(DRAFT)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  @@unique([userId, createdAt]) // Changed unique constraint for monthly tracking
  @@map("monthly_submissions")
}

// 1. Code of Conduct
model CodeOfConduct {
  id                String                @id @default(uuid())
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
  userId            String
  user              User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  status            SubmissionStatus      @default(DRAFT)
  details           CodeOfConductDetail[]

  @@map("code_of_conduct")
}

model CodeOfConductDetail {
  id                String           @id @default(uuid())
  name              String           // Proprietor/Partner/Director
  signature         String
  date              DateTime
  conductId         String
  conduct           CodeOfConduct    @relation(fields: [conductId], references: [id], onDelete: Cascade)

  @@map("code_of_conduct_details")
}

// 2. Declaration Cum Undertaking
model DeclarationCumUndertaking {
  id                          String                            @id @default(uuid())
  createdAt                   DateTime                          @default(now())
  updatedAt                   DateTime                          @updatedAt
  userId                      String
  user                        User                              @relation(fields: [userId], references: [id], onDelete: Cascade)
  status                      SubmissionStatus                  @default(DRAFT)

  collectionManagers          DeclarationCollectionManager[]

  @@map("declaration_cum_undertaking")
}

model DeclarationCollectionManager {
  id                    String                    @id @default(uuid())
  name                  String
  employeeId            String
  signature             String
  declarationId         String
  declaration           DeclarationCumUndertaking @relation(fields: [declarationId], references: [id], onDelete: Cascade)

  @@map("declaration_collection_managers")
}

// 3. Agency Visit Details
model AgencyVisit {
  id        String           @id @default(uuid())
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  status    SubmissionStatus @default(DRAFT)
  agencyId  String
  agency    User             @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  details   VisitDetail[]

  @@map("agency_visits")
}

model VisitDetail {
  id             String      @id @default(uuid())
  srNo           String
  dateOfVisit    String // Consider changing to DateTime if precision needed
  employeeId     String
  employeeName   String
  mobileNo       String
  branchLocation String
  product        String
  bucketDpd      String
  timeIn         String // Consider changing to DateTime
  timeOut        String // Consider changing to DateTime
  signature      String
  purposeOfVisit String
  visitId        String
  visit          AgencyVisit @relation(fields: [visitId], references: [id], onDelete: Cascade)

  @@map("visit_details")
}

// 4. Monthly Compliance Declaration
model MonthlyCompliance {
  id        String           @id @default(uuid())
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  status    SubmissionStatus @default(DRAFT)
  details   MonthlyComplianceDetail[]

  @@map("monthly_compliance")
}

model MonthlyComplianceDetail {
  id                      String            @id @default(uuid())
  srNo                    String
  complianceParameters    String
  complied                String            // Yes/No/NA
  agencyRemarks           String?
  collectionManagerName   String
  collectionManagerEmpId  String
  collectionManagerSign   String
  date                    DateTime
  complianceId            String
  compliance              MonthlyCompliance @relation(fields: [complianceId], references: [id], onDelete: Cascade)

  @@map("monthly_compliance_details")
}

// 5. Asset Management Declaration
model AssetManagement {
  id        String           @id @default(uuid())
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  status    SubmissionStatus @default(DRAFT)
  details   AssetManagementDetail[]

  @@map("asset_management")
}

model AssetManagementDetail {
  id                    String          @id @default(uuid())
  srNo                  String
  systemCpuSerialNo     String
  ipAddress             String
  executiveName         String
  idCardNumber          String
  printerAccess         String          // Yes/No with reason
  assetDisposed         String          // data purged info
  assetManagementId     String
  assetManagement       AssetManagement @relation(fields: [assetManagementId], references: [id], onDelete: Cascade)

  @@map("asset_management_details")
}

// 6. Telephone Lines Declaration
model TelephoneDeclaration {
  id        String           @id @default(uuid())
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  status    SubmissionStatus @default(DRAFT)
  details   TelephoneDetail[]

  @@map("telephone_declaration")
}

model TelephoneDetail {
  id                    String               @id @default(uuid())
  srNo                  String
  telephoneNo           String
  username              String
  executiveCategory     String
  recordingLine         String               // Yes/No
  remarks               String?
  telephoneDeclarationId String
  telephoneDeclaration  TelephoneDeclaration @relation(fields: [telephoneDeclarationId], references: [id], onDelete: Cascade)

  @@map("telephone_details")
}

// 7. Agency Manpower Register
model AgencyManpowerRegister {
  id        String           @id @default(uuid())
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  status    SubmissionStatus @default(DRAFT)
  details   ManpowerDetail[]

  @@map("agency_manpower_register")
}

model ManpowerDetail {
  id                      String                  @id @default(uuid())
  srNo                    String
  executiveCategory       String                  // FOS/Tele-caller/Tracer/Backend
  hhdIdOfFos              String?
  axisIdOfFos             String?
  fosFullName             String
  dateOfJoining           DateTime
  product                 String
  cocSigned               String                  // Yes/No
  collectionManagerName   String
  collectionManagerId     String
  collectionManagerSign   String
  dateOfResignation       DateTime?
  idCardsIssuanceDate     DateTime?
  idCardReturnDate        DateTime?
  executiveSignature      String
  remarks                 String?
  manpowerRegisterId      String
  manpowerRegister        AgencyManpowerRegister @relation(fields: [manpowerRegisterId], references: [id], onDelete: Cascade)

  @@map("manpower_details")
}

// 8. Declaration of Product
model ProductDeclaration {
  id        String           @id @default(uuid())
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  status    SubmissionStatus @default(DRAFT)
  details   ProductDetail[]

  @@map("product_declaration")
}

model ProductDetail {
  id                        String              @id @default(uuid())
  product                   String
  bucket                    String
  countOfCaseAllocated      Int
  collectionManagerName     String
  collectionManagerLocation String
  cmSign                    String
  productDeclarationId      String
  productDeclaration        ProductDeclaration @relation(fields: [productDeclarationId], references: [id], onDelete: Cascade)

  @@map("product_details")
}

// 9. Agency Penalty Matrix
model AgencyPenaltyMatrix {
  id        String           @id @default(uuid())
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  status    SubmissionStatus @default(DRAFT)
  details   PenaltyDetail[]

  @@map("agency_penalty_matrix")
}

model PenaltyDetail {
  id                          String                @id @default(uuid())
  noticeRefNo                 String
  nonComplianceMonth          String
  parameter                   String
  product                     String
  penaltyAmount               Decimal               @db.Decimal(10, 2) // Added precision
  penaltyDeductedMonth        String
  correctiveActionTaken       String
  agency                      String
  agencyAuthorisedPersonSign  String
  signOfFpr                   String
  penaltyMatrixId             String
  penaltyMatrix               AgencyPenaltyMatrix @relation(fields: [penaltyMatrixId], references: [id], onDelete: Cascade)

  @@map("penalty_details")
}

// 10. Agency Training Tracker
model AgencyTrainingTracker {
  id        String           @id @default(uuid())
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  status    SubmissionStatus @default(DRAFT)
  details   TrainingDetail[]

  @@map("agency_training_tracker")
}

model TrainingDetail {
  id                  String                 @id @default(uuid())
  dateOfTraining      DateTime
  trainingAgenda      String
  trainingName        String
  trainerName         String
  trainerEmpId        String
  noOfAttendees       Int
  trainerRemarks      String?
  trainingTrackerId   String
  trainingTracker     AgencyTrainingTracker @relation(fields: [trainingTrackerId], references: [id], onDelete: Cascade)

  @@map("training_details")
}

// 11. Proactive Escalation Management Tracker
model ProactiveEscalationTracker {
  id        String           @id @default(uuid())
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  status    SubmissionStatus @default(DRAFT)
  details   ProactiveEscalationDetail[]

  @@map("proactive_escalation_tracker")
}

model ProactiveEscalationDetail {
  id                        String                      @id @default(uuid())
  lanCardNo                 String
  customerName              String
  product                   String
  currentBucket             String
  dateOfContact             DateTime
  modeOfContact             String                      // Field Visit/Call
  dateOfTrailUploaded       DateTime?
  listOfCaseWithReasons     String
  collectionManagerNameId   String
  escalationTrackerId       String
  escalationTracker         ProactiveEscalationTracker @relation(fields: [escalationTrackerId], references: [id], onDelete: Cascade)

  @@map("proactive_escalation_details")
}

// 12. Escalation Details
model EscalationDetails {
  id        String           @id @default(uuid())
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  status    SubmissionStatus @default(DRAFT)
  details   EscalationDetail[]

  @@map("escalation_details_form")
}

model EscalationDetail {
  id                        String             @id @default(uuid())
  customerName              String
  loanCardNo                String
  productBucketDpd          String
  dateEscalation            DateTime
  escalationDetail          String
  collectionManagerRemark   String?
  collectionManagerSign     String
  escalationDetailsId       String
  escalationDetails         EscalationDetails @relation(fields: [escalationDetailsId], references: [id], onDelete: Cascade)

  @@map("escalation_detail_entries")
}

// 13. Payment Register
model PaymentRegister {
  id        String           @id @default(uuid())
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  status    SubmissionStatus @default(DRAFT)
  details   PaymentDetail[]

  @@map("payment_register")
}

model PaymentDetail {
  id                    String          @id @default(uuid())
  srNo                  String
  month                 String
  eReceiptNo            String
  accountNo             String
  customerName          String
  receiptAmount         Decimal         @db.Decimal(10, 2) // Added precision
  modeOfPayment         String
  depositionDate        DateTime
  fosHhdId              String
  fosName               String
  fosSign               String
  cmName                String
  cmVerificationStatus  String
  remarks               String?
  paymentRegisterId     String
  paymentRegister       PaymentRegister @relation(fields: [paymentRegisterId], references: [id], onDelete: Cascade)

  @@map("payment_details")
}

// 14. Repo Kit Tracker
model RepoKitTracker {
  id        String           @id @default(uuid())
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  status    SubmissionStatus @default(DRAFT)
  details   RepoKitDetail[]

  @@map("repo_kit_tracker")
}

model RepoKitDetail {
  id                      String         @id @default(uuid())
  srNo                    String
  repoKitNo               String
  issueDateFromBank       DateTime
  lanNo                   String
  product                 String
  bucketDpd               String
  usedUnused              String         // Used/Unused
  executiveSign           String
  dateOfReturnToCo        DateTime?
  collectionManagerEmpId  String
  collectionManagerSign   String
  repoKitTrackerId        String
  repoKitTracker          RepoKitTracker @relation(fields: [repoKitTrackerId], references: [id], onDelete: Cascade)

  @@map("repo_kit_details")
}

// Approval Request System
model ApprovalRequest {
  id            String            @id @default(uuid())
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  userId        String
  user          User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  formType      String            // Type of form being requested for approval
  formId        String            // ID of the specific form record
  requestType   ApprovalType
  reason        String
  documentPath  String?           // Path to uploaded proof document
  status        ApprovalStatus    @default(PENDING)
  adminResponse String?
  reviewedAt    DateTime?
  reviewedBy    String?           // User ID of admin who reviewed

  @@map("approval_requests")
}

// File Upload Management
model UploadedFile {
  id            String   @id @default(uuid())
  createdAt     DateTime @default(now())
  fileName      String
  originalName  String
  filePath      String
  fileSize      Int      // in bytes
  mimeType      String
  uploadedBy    String   // User ID

  @@map("uploaded_files")
}

model Session {
  id             String   @id @default(uuid())
  createdAt      DateTime @default(now()) // Added default
  updatedAt      DateTime @updatedAt
  expiresAt      DateTime
  token          String   @unique
  ipAddress      String?
  userAgent      String?
  impersonatedBy String?
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model Account {
  id                    String    @id @default(uuid())
  createdAt             DateTime  @default(now()) // Added default
  updatedAt             DateTime  @updatedAt
  accountId             String
  providerId            String
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId, accountId]) // Added unique constraint
  @@map("accounts")
}

model Verification {
  id         String    @id @default(uuid())
  createdAt  DateTime? @default(now()) // Added default
  updatedAt  DateTime? @updatedAt
  identifier String
  value      String
  expiresAt  DateTime

  @@unique([identifier, value]) // Added unique constraint
  @@map("verifications")
}

// Notifications System
model Notification {
  id            String              @id @default(uuid())
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  userId        String
  user          User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  type          NotificationType
  title         String
  message       String
  link          String?             // Optional link to related resource

  read          Boolean             @default(false)
  readAt        DateTime?

  // Related entities
  relatedId     String?             // ID of related form/request
  relatedType   String?             // Type: 'form', 'approval', etc.

  @@map("notifications")
  @@index([userId, read])
  @@index([createdAt])
}

// Activity Logs
model ActivityLog {
  id            String        @id @default(uuid())
  createdAt     DateTime      @default(now())
  userId        String
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  action        ActivityAction
  entityType    String        // form type or 'approval_request'
  entityId      String?       // ID of the entity

  description   String
  metadata      Json?         // Additional data (old values, new values, etc.)

  ipAddress     String?
  userAgent     String?

  @@map("activity_logs")
  @@index([userId, createdAt])
  @@index([entityType, entityId])
}

// Collection Manager Profile
model CollectionManagerProfile {
  id                    String   @id @default(uuid())
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  userId                String   @unique
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  employeeId            String   @unique
  designation           String
  department            String?
  productsAssigned      String[] // Array of products like ["Credit Card", "Personal Loan"]
  
  // Supervisor relationship (self-referencing, optional)
  supervisorId          String?
  supervisor            CollectionManagerProfile? @relation("CMSupervisor", fields: [supervisorId], references: [id], onDelete: SetNull)
  subordinates          CollectionManagerProfile[] @relation("CMSupervisor")
  
  // Agency assignments
  agencyAssignments     CMAgencyAssignment[]
  
  // Approvals given by this CM
  approvalsGiven        CMApproval[]
  
  // Notification preferences
  notificationsEnabled  Boolean  @default(true)
  emailNotifications    Boolean  @default(true)
  
  @@map("collection_manager_profiles")
  @@index([employeeId])
  @@index([supervisorId])
}

// CM to Agency Assignment
model CMAgencyAssignment {
  id              String   @id @default(uuid())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  cmProfileId     String
  cmProfile       CollectionManagerProfile @relation(fields: [cmProfileId], references: [id], onDelete: Cascade)
  
  agencyId        String
  agency          User     @relation("CMAssignedAgencies", fields: [agencyId], references: [id], onDelete: Cascade)
  
  assignedBy      String   // Admin/SuperAdmin user ID who made the assignment
  assignedAt      DateTime @default(now())
  isActive        Boolean  @default(true)
  
  // Track if CM has viewed this assignment
  viewedByAt      DateTime?
  
  @@unique([cmProfileId, agencyId])
  @@map("cm_agency_assignments")
  @@index([cmProfileId])
  @@index([agencyId])
  @@index([isActive])
}

// CM Approval Records (tracks all approvals given via CM session)
model CMApproval {
  id                    String   @id @default(uuid())
  createdAt             DateTime @default(now())
  
  cmProfileId           String
  cmProfile             CollectionManagerProfile @relation(fields: [cmProfileId], references: [id], onDelete: Cascade)
  
  agencyId              String
  agency                User     @relation("CMApprovals", fields: [agencyId], references: [id], onDelete: Cascade)
  
  formType              String   // e.g., "agencyVisits", "assetManagement"
  formId                String   // ID of the form
  rowId                 String?  // If approval was for specific row
  
  approvalSignature     String   // Full signature text
  productTag            String   // Product for which approval was given
  remarks               String?
  
  ipAddress             String?
  userAgent             String?
  
  // Link to supervisor for reporting
  reportedToSupervisor  Boolean  @default(false)
  
  @@map("cm_approvals")
  @@index([cmProfileId])
  @@index([agencyId])
  @@index([formType, formId])
  @@index([createdAt])
}

// NEW MODELS START HERE
// Auditing Firm model
model AuditingFirm {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  name      String   @unique // "Agrawal & Dhandhania", "Sumeru", "Patil"

  // Relations
  auditors          Auditor[]
  audits            Audit[]
  agencyAssignments AgencyAssignment[] // Added relation

  @@map("auditing_firms")
}

// Auditor model (links users to firms)
model Auditor {
  id          String       @id @default(uuid())
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  userId      String       @unique
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  firmId      String
  firm        AuditingFirm @relation(fields: [firmId], references: [id], onDelete: Cascade)

  // Audits conducted by this auditor
  audits      Audit[]

  @@map("auditors")
}

// Agency Assignment to Auditing Firm
model AgencyAssignment {
  id          String       @id @default(uuid())
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  agencyId    String
  agency      User         @relation(fields: [agencyId], references: [id], onDelete: Cascade)

  firmId      String
  firm        AuditingFirm @relation(fields: [firmId], references: [id], onDelete: Cascade)

  assignedBy  String       // Super Admin User ID who assigned
  assignedAt  DateTime     @default(now())

  isActive    Boolean      @default(true)

  @@unique([agencyId, firmId])
  @@map("agency_assignments")
}

// Audit model
model Audit {
  id                String       @id @default(uuid())
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  // Agency being audited
  agencyId          String
  agency            User         @relation("AuditAgency", fields: [agencyId], references: [id], onDelete: Cascade) // Clarified relation name

  // Auditing firm and auditor
  firmId            String
  firm              AuditingFirm @relation(fields: [firmId], references: [id], onDelete: Cascade)

  auditorId         String
  auditor           Auditor      @relation(fields: [auditorId], references: [id])

  // Audit details
  auditDate         DateTime
  auditorName       String       // Name of person who conducted audit
  auditorEmployeeId String?      // Employee ID of auditor
  location          String?
  remarks           String?

  status            AuditStatus  @default(IN_PROGRESS)

  // Relations
  observations      Observation[]

  @@map("audits")
}

// Observation model
model Observation {
  id                 String              @id @default(uuid())
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt

  // Related audit
  auditId            String
  audit              Audit               @relation(fields: [auditId], references: [id], onDelete: Cascade)

  // Observation details
  observationNumber  String              // e.g., "OBS-001"
  category           String              // e.g., "Compliance", "Documentation", "Process"
  severity           ObservationSeverity @default(MEDIUM)
  description        String              @db.Text
  evidenceRequired   Boolean             @default(false)

  // Visibility and status
  visibleToAgency    Boolean             @default(false)
  sentToAgencyAt     DateTime?
  sentBy             String?             // Admin User ID who sent to agency

  status             ObservationStatus   @default(PENDING_ADMIN_REVIEW)

  // Agency response
  agencyResponse     String?             @db.Text
  agencyAccepted     Boolean?
  agencyResponseDate DateTime?
  evidenceSubmitted  Boolean             @default(false)
  evidencePath       String?

  // Deadline for agency response
  responseDeadline   DateTime?
  autoAcceptedAt     DateTime?

  // Penalty
  penaltyAssigned    Boolean             @default(false)
  penaltyId          String?             @unique
  penalty            Penalty?            @relation(fields: [penaltyId], references: [id])

  @@map("observations")
  @@index([auditId])
  @@index([status])
}

// Penalty model
model Penalty {
  id                   String        @id @default(uuid())
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt

  // Related observation
  observationId        String        @unique
  observation          Observation?  // Relation field defined implicitly by @relation on Observation.penalty

  // Agency
  agencyId             String
  agency               User          @relation(fields: [agencyId], references: [id], onDelete: Cascade)

  // Penalty details
  penaltyAmount        Decimal       @db.Decimal(10, 2)
  penaltyReason        String        @db.Text
  deductionMonth       String        // Month when penalty will be deducted

  // Status
  status               PenaltyStatus @default(DRAFT)
  assignedBy           String        // Admin User ID who assigned penalty
  assignedAt           DateTime      @default(now())
  submittedAt          DateTime?

  // Agency acknowledgment
  acknowledgedByAgency Boolean       @default(false)
  acknowledgedAt       DateTime?

  // Corrective action
  correctiveAction     String?       @db.Text

  @@map("penalties")
  @@index([agencyId])
  @@index([status])
}
// NEW MODELS END HERE

// Enums
enum UserRole {
  SUPER_ADMIN
  USER
  ADMIN
  AUDITOR
  COLLECTION_MANAGER
  // Remove AUDITING_FIRM if it's still here
}

enum SubmissionStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
}

enum ApprovalType {
  UPDATE_SUBMITTED_FORM
  UPDATE_PREVIOUS_MONTH
  DELETE_RECORD
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  REVISED // May not be needed, consider removing if REJECTED covers this
}

enum NotificationType {
  APPROVAL_REQUESTED      // When user requests approval
  APPROVAL_APPROVED       // When admin approves request
  APPROVAL_REJECTED       // When admin rejects request
  DOCUMENT_REQUESTED      // When admin requests document
  FORM_SUBMITTED          // When form is submitted
  FORM_LOCKED             // When form is locked after resubmission
  SYSTEM_ALERT            // System notifications (e.g., audit assigned, observation received, penalty assigned)
}

enum ActivityAction {
  FORM_CREATED
  FORM_UPDATED
  FORM_SUBMITTED
  FORM_RESUBMITTED
  FORM_DELETED
  APPROVAL_REQUESTED
  APPROVAL_GRANTED
  APPROVAL_REJECTED
  DOCUMENT_UPLOADED
  USER_LOGIN
  USER_LOGOUT
  SETTINGS_CHANGED
  // NEW Audit Actions
  AUDIT_CREATED
  OBSERVATION_ADDED
  OBSERVATION_SENT_TO_AGENCY
  OBSERVATION_RESPONDED
  PENALTY_ASSIGNED
  PENALTY_SUBMITTED
  AGENCY_ASSIGNED_TO_FIRM
}

// NEW Enums START HERE
enum AuditStatus {
  IN_PROGRESS
  COMPLETED       // Auditor finished, pending admin review/action
  UNDER_REVIEW    // Admin is reviewing
  CLOSED          // Audit process complete for this cycle
}

enum ObservationSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ObservationStatus {
  PENDING_ADMIN_REVIEW      // Observation created by auditor, needs admin check
  SENT_TO_AGENCY          // Admin sent to agency, awaiting response
  AWAITING_AGENCY_RESPONSE  // Agency is reviewing (optional state if needed)
  AGENCY_ACCEPTED         // Agency accepted the observation
  AGENCY_DISPUTED         // Agency disputed with evidence (needs admin review)
  AUTO_ACCEPTED           // Auto-accepted due to timeout (treated as accepted)
  RESOLVED                // Admin marked as resolved (after review, potentially no penalty)
  CLOSED                  // Closed with penalty assigned or resolved without penalty
}

enum PenaltyStatus {
  DRAFT      // Admin created, not yet visible to agency
  SUBMITTED  // Admin submitted, visible to agency
  ACKNOWLEDGED // Agency viewed/acknowledged the penalty
  PAID       // Penalty amount deducted/paid (future state maybe)
}
// NEW Enums END HERE